# Investment Trading Service API Documentation

## Обзор

Investment Trading Service предоставляет REST API для создания и управления торговыми заявками через Tinkoff Invest API.

**Base URL:** `http://localhost:8089/api/orders`

## Аутентификация

В настоящее время API работает без аутентификации. В продакшене рекомендуется добавить токен-авторизацию.

## Общие правила

### Формат времени
- **Формат:** `HH:mm:ss` (например, `14:30:00`)
- **Таймзона:** `Europe/Moscow`
- **Специальное значение:** `"now"` - немедленное исполнение
- **Ограничение:** Время не может быть в прошлом

### Округление цен
- Все цены округляются до **6 знаков после запятой**
- Используется `RoundingMode.HALF_UP`

### Направления торговли
- `"buy"` - покупка
- `"sell"` - продажа  
- `"all"` - и покупка, и продажа (только для групповых заявок)

## API Endpoints

### 1. Создание групповой заявки

**POST** `/api/orders/group`

Создает заявки для нескольких инструментов с расчетом цен на основе опорной цены.

#### Request Body

```json
{
  "instruments": ["BBG004730ZJ9", "BBG004730N88"],
  "main_price": "2500.50",
  "amount": 100000,
  "direction": "buy",
  "start_time": "14:30:00",
  "levels": {
    "level1": 1.5,
    "level2": 3.0,
    "level3": 5.0
  }
}
```

#### Поля запроса

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `instruments` | Array[String] | ✅ | Список FIGI инструментов |
| `main_price` | String | ✅ | Опорная цена для расчета |
| `amount` | BigDecimal | ✅ | Общая сумма для инвестирования |
| `direction` | String | ✅ | Направление: "buy", "sell", "all" |
| `start_time` | String | ✅ | Время исполнения: "HH:mm:ss" или "now" |
| `levels` | Object | ✅ | Процентные уровни (1-100%) |

#### Levels (Уровни)

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `level1` | BigDecimal | ✅ | Процент отклонения (0.00-100.00) |
| `level2` | BigDecimal | ❌ | Процент отклонения (0.00-100.00) |
| `level3` | BigDecimal | ❌ | Процент отклонения (0.00-100.00) |

#### Response

```json
[
  {
    "orderId": "123e4567-e89b-12d3-a456-426614174000",
    "instrumentId": "BBG004730ZJ9",
    "quantity": 10,
    "price": {
      "units": 2537,
      "nano": 575000000
    },
    "direction": "ORDER_DIRECTION_BUY",
    "accountId": "account123",
    "startTime": "14:30:00",
    "status": "PENDING"
  }
]
```

### 2. Создание заявки с прямыми ценами (один инструмент)

**POST** `/api/orders/group/with-price`

Создает заявки для одного инструмента с указанием точных цен уровней.

#### Request Body

```json
{
  "instrument": "BBG004730ZJ9",
  "amount": 100000,
  "direction": "sell",
  "start_time": "now",
  "levels": {
    "level1": 75.50,
    "level2": 80.25
  }
}
```

#### Поля запроса

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `instrument` | String | ✅ | FIGI инструмента |
| `amount` | BigDecimal | ✅ | Общая сумма для инвестирования |
| `direction` | String | ✅ | Направление: "buy", "sell" |
| `start_time` | String | ✅ | Время исполнения: "HH:mm:ss" или "now" |
| `levels` | Object | ✅ | Прямые цены уровней |

#### Levels (Уровни) - прямые цены

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `level1` | BigDecimal | ✅ | Точная цена инструмента |
| `level2` | BigDecimal | ❌ | Точная цена инструмента |
| `level3` | BigDecimal | ❌ | Точная цена инструмента |

#### Response

```json
{
  "orders": [
    {
      "orderId": "123e4567-e89b-12d3-a456-426614174000",
      "instrumentId": "BBG004730ZJ9",
      "quantity": 1324,
      "price": {
        "units": 75,
        "nano": 500000000
      },
      "direction": "ORDER_DIRECTION_SELL",
      "accountId": "account123",
      "startTime": "18:13:22",
      "status": "SENT"
    }
  ],
  "instrumentPrice": 0
}
```

### 3. Создание одиночной заявки с прямыми ценами

**POST** `/api/orders/single/with-price`

Аналогично предыдущему endpoint, но возвращает список заявок напрямую.

### 4. Получение заявок из кэша

**GET** `/api/orders/cache`

Возвращает все заявки, находящиеся в кэше.

### 5. Получение заявки по ID

**GET** `/api/orders/{orderId}`

Возвращает информацию о конкретной заявке.

#### Path Parameters

| Параметр | Тип | Описание |
|----------|-----|----------|
| `orderId` | UUID | Идентификатор заявки |

### 6. Принудительная отправка заявки

**POST** `/api/orders/{orderId}/send`

Принудительно отправляет заявку в T-Invest API.

### 7. Отмена заявки

**POST** `/api/orders/{orderId}/cancel`

Отменяет заявку (удаляет из кэша и БД).

### 8. Удаление заявки

**DELETE** `/api/orders/{orderId}`

Удаляет заявку из системы.

### 9. Получение заявок по статусу

**GET** `/api/orders/status/{status}`

Возвращает заявки с указанным статусом.

#### Возможные статусы:
- `PENDING` - ожидает исполнения
- `SENT` - отправлена в T-Invest
- `ERROR` - ошибка при отправке

### 10. Получение заявок готовых к отправке

**GET** `/api/orders/ready/{time}`

Возвращает заявки, готовые к отправке в указанное время.

#### Path Parameters

| Параметр | Тип | Описание |
|----------|-----|----------|
| `time` | String | Время в формате HH:mm:ss |

### 11. Статистика заявок

**GET** `/api/orders/statistics`

Возвращает статистику по всем заявкам.

### 12. Статистика планировщика

**GET** `/api/orders/scheduler/statistics`

Возвращает статистику работы планировщика.

### 13. Заявки с ошибками

**GET** `/api/orders/errors`

Возвращает все заявки со статусом ERROR.

### 14. Лимиты инструмента

**GET** `/api/orders/limits/{instrumentId}`

Возвращает лимиты для указанного инструмента.

## Коды ошибок

### 400 Bad Request - Ошибки валидации

```json
{
  "message": "Время начала исполнения (start_time) не может быть в прошлом",
  "errorCode": "VALIDATION_ERROR",
  "status": 400,
  "path": "/api/orders/group/with-price",
  "timestamp": "2025-10-16T18:13:22",
  "field": "start_time",
  "rejectedValue": "16:58:00",
  "suggestion": "Используйте текущее время или время в будущем в таймзоне Europe/Moscow",
  "operationContext": "Управление заявками",
  "documentationUrl": "/api/docs"
}
```

#### Возможные ошибки валидации:

| Ошибка | Описание | Решение |
|--------|----------|---------|
| `Список инструментов не может быть пустым` | Поле `instruments` пустое | Укажите хотя бы один FIGI инструмента |
| `Опорная цена не может быть пустой` | Поле `main_price` отсутствует | Укажите корректную цену |
| `Сумма не может быть пустой` | Поле `amount` отсутствует | Укажите сумму больше 0 |
| `Направление торговли не может быть пустым` | Поле `direction` отсутствует | Укажите: "buy", "sell" или "all" |
| `Направление торговли должно быть: buy, sell или all` | Неверное значение direction | Используйте только разрешенные значения |
| `Время начала не может быть null` | Поле `start_time` отсутствует | Укажите время в формате HH:mm:ss или "now" |
| `Должен быть хотя бы один уровень` | Поле `levels` отсутствует | Укажите level1 (обязательно) |
| `Процент не может быть отрицательным` | Отрицательное значение уровня | Используйте значения от 0.00 до 100.00 |
| `Процент не может превышать 100%` | Слишком большое значение | Используйте значения от 0.00 до 100.00 |
| `ID заявки не может быть пустым` | Пустой orderId | Укажите корректный UUID |
| `ID заявки должен быть в формате UUID` | Неверный формат UUID | Используйте формат: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx |
| `Некорректный статус заявки` | Неверный статус | Используйте: PENDING, SENT, ERROR |
| `Некорректный формат времени` | Неверный формат времени | Используйте HH:mm:ss |

### 422 Unprocessable Entity - Ошибки бизнес-логики

```json
{
  "message": "Не удалось создать заявки для инструмента",
  "errorCode": "ORDERS_NOT_CREATED",
  "status": 422,
  "path": "/api/orders/group/with-price",
  "timestamp": "2025-10-16T18:13:22",
  "suggestion": "Проверьте корректность данных инструмента и уровней",
  "operationContext": "Управление заявками",
  "documentationUrl": "/api/docs"
}
```

#### Возможные ошибки бизнес-логики:

| Ошибка | Описание | Решение |
|--------|----------|---------|
| `Не удалось создать заявки для инструмента` | Ошибка при генерации заявок | Проверьте корректность данных |
| `Заявка с ID 'xxx' не найдена` | Заявка не существует | Проверьте правильность ID |
| `Не удалось отменить заявку` | Ошибка при отмене | Повторите попытку позже |
| `Не удалось удалить заявку` | Ошибка при удалении | Повторите попытку позже |

### 500 Internal Server Error - Внутренние ошибки

```json
{
  "message": "Внутренняя ошибка при создании заявки с ценой",
  "errorCode": "INTERNAL_SERVER_ERROR",
  "status": 500,
  "path": "/api/orders/group/with-price",
  "timestamp": "2025-10-16T18:13:22",
  "suggestion": "Обратитесь к администратору системы",
  "operationContext": "Управление заявками",
  "documentationUrl": "/api/docs"
}
```

## Примеры использования

### Создание групповой заявки на покупку

```bash
curl -X POST http://localhost:8089/api/orders/group \
  -H "Content-Type: application/json" \
  -d '{
    "instruments": ["BBG004730ZJ9", "BBG004730N88"],
    "main_price": "2500.50",
    "amount": 100000,
    "direction": "buy",
    "start_time": "14:30:00",
    "levels": {
      "level1": 1.5,
      "level2": 3.0
    }
  }'
```

### Немедленная отправка заявки

```bash
curl -X POST http://localhost:8089/api/orders/group/with-price \
  -H "Content-Type: application/json" \
  -d '{
    "instrument": "BBG004730ZJ9",
    "amount": 50000,
    "direction": "sell",
    "start_time": "now",
    "levels": {
      "level1": 75.50
    }
  }'
```

### Получение статистики

```bash
curl http://localhost:8089/api/orders/statistics
```

## Лимиты и ограничения

### T-Invest API
- Соблюдайте rate limits T-Invest API
- Максимальное количество заявок в группе: определяется лимитами инструмента

### Валидация данных
- Максимум 3 уровня цен
- Процентные уровни: 0.00 - 100.00%
- Сумма: больше 0
- Время: не в прошлом

### Производительность
- Максимальное время обработки запроса: 30 секунд
- Рекомендуемый размер группы инструментов: до 10

## Поддержка

При возникновении проблем:
1. Проверьте формат запроса согласно документации
2. Убедитесь в корректности FIGI инструментов
3. Проверьте статус T-Invest API
4. Обратитесь к администратору системы

**Версия API:** 1.0.0  
**Дата обновления:** 2025-10-16
